name: CI - Build and Test Service

on:
  pull_request:
    branches:
      - main
      - 'feature/**'
      - 'staging/4*'

jobs:
  test-prod:
    name: "Test: Productive start"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build Prod
      run: make build-prod

    - name: Create secret
      run: mkdir secrets && echo -n "openslides" > secrets/postgres_password

    - name: Start container
      run: |
          source .env
          docker compose up -d --wait

    - name: Test that reader is up and running
      run: curl -I http://localhost:9010/

    - name: Test that writer is up and running
      run: curl -I http://localhost:9011/

  ci-tests:
    name: "CI Tests"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build Tests
      run: make build-test

    - name: Execute tests
      run: make run-ci

  test-full-system:
    name: "Full System Tests"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build Dev
      run: make build-dev

    - name: Run System Tests
      run: make ci-run-system-tests

  # This setups and runs the dev/run-tests.sh script
  run-test-script:
    name: Run-tests.sh Script
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Test
        uses: OpenSlides/OpenSlides/dev/actions/build-and-test-service@main
        with:
          service: datastore